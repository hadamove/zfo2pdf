<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ZFOÔ∏è na PDF</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/forge/1.3.1/forge.min.js"
    integrity="sha512-95iy0RZIbw3H/FgfAj2wnCQJlzFQ+eaSfUeV/l8WVyGHKSRMzm3M/O+85j9ba/HFphkijrCTDjcuDX0BL2lthA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    @keyframes fadeInPop {
      from {
        opacity: 0;
        transform: scale(0.95);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .fade-in-pop {
      animation: fadeInPop 0.25s ease-out forwards;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-image: radial-gradient(circle, #ddd 1px, transparent 1px), radial-gradient(circle, #ddd 1px, transparent 1px);
      background-position: 0 0, 15px 0px;
      background-size: 15px 15px;
    }
  </style>
</head>

<body class="min-h-screen bg-gray-50 flex flex-col">

  <h1 class="text-5xl py-8 text-center">
    ZFO ‚ñ∑ PDF
  </h1>

  <div id="content" class="max-w-xl mx-auto">
    <div class="flex flex-col gap-4 px-8">
      <!-- Guide -->
      <ol class="text-left space-y-4 my-4 list-decimal list-inside">
        <li><strong>Naƒçti soubor:</strong> klikni na tlaƒç√≠tko "Naƒçti soubor" and vyber soubor datov√© schr√°nky ze kter√©ho
          chce≈° extrahovat p≈ô√≠lohy.
        </li>
        <li><strong>Konvertuj:</strong> Po naƒçten√≠ souboru klikni na tlaƒç√≠tko "Konvertuj" a poƒçkej na dokonƒçen√≠
          konverze.
        </li>
        <li><strong>Ulo≈æ:</strong> Po dokonƒçen√≠ konverze se ti zobraz√≠ odkazy na sta≈æen√≠ jednotliv√Ωch p≈ô√≠loh. Klikni na
          odkaz a ulo≈æ si p≈ô√≠lohu na sv≈Øj poƒç√≠taƒç.
      </ol>

      <!-- User Input -->
      <label for="fileInput"
        class="cursor-pointer py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition duration-150 ease-in-out flex justify-center items-center">
        üì§ Naƒçti soubor
      </label>
      <input type="file" id="fileInput" class="sr-only" onchange="onFileInputChanged()">

      <button id="transformButton" onclick="transformFile()"
        class="bg-gray-800 text-white py-2 px-4 rounded-md hover:bg-gray-900 transition duration-150 ease-in-out flex justify-center items-center">
        ‚ö°Ô∏è Konvertuj
      </button>

      <!-- User Output -->
      <div id="errorContainer" class="text-sm text-red-500 mt-2 hidden"></div>
      <div id="result" class="hidden">
        <h2 class="text-2xl mt-4 text-center">üìé P≈ô√≠lohy</h2>
        <div id="downloadLinks"></div>
      </div>
    </div>
  </div>

  <footer class="mt-auto py-4 text-center text-sm text-gray-600">
    ¬© 2024 ZFO to PDF Converter
  </footer>

  <script>
    function onFileInputChanged() {
      const input = document.getElementById('fileInput');
      const label = document.querySelector('label[for="fileInput"]');
      const fileName = input.files.length ? input.files[0].name : null;
      label.textContent = fileName ? `üìë ${fileName}` : 'üì§ Nahraj s√∫bor';

      displayError('');
    }

    function displayError(message) {
      const errorContainer = document.getElementById('errorContainer');
      if (message) {
        errorContainer.textContent = message;
        errorContainer.classList.remove('hidden');
      } else {
        errorContainer.textContent = '';
        errorContainer.classList.add('hidden');
      }
    }

    const transformFile = () => {
      const fileInput = document.getElementById('fileInput');

      if (!fileInput.files || fileInput.files.length === 0) {
        displayError('No file selected. Please upload a ZFO file.');
        return;
      }

      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = function (event) {
        try {
          const zfoContent = event.target.result;
          const xmlContent = extractXmlContentFromZfo(zfoContent);
          transformToPdfAndAddLinks(xmlContent);
        } catch (error) {
          displayError('An error occurred during the conversion process. Please try again.');
        }
      };

      reader.onerror = function (event) {
        displayError('An error occurred reading the file. Please try again.');
      };

      reader.readAsBinaryString(file);
    }

    const extractXmlContentFromZfo = (zfoContent) => {
      const pkcs7Der = forge.util.createBuffer(zfoContent, 'binary');
      const pkcs7Asn1 = forge.asn1.fromDer(pkcs7Der);
      const pkcs7 = forge.pkcs7.messageFromAsn1(pkcs7Asn1);

      let xmlContentParts = pkcs7.rawCapture.content.value[0].value;

      let xmlContent = xmlContentParts.map(part => {
        let binaryString = part.value;
        let buffer = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          buffer[i] = binaryString.charCodeAt(i);
        }

        let textDecoder = new TextDecoder("utf-8");
        return textDecoder.decode(buffer);
      }).join('');

      if (!xmlContent) {
        throw new Error('No XML content found in the ZFO file.');
      }

      return xmlContent;
    }

    const transformToPdfAndAddLinks = (xmlContent) => {
      const listStylesheet = `
    <xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" version="1.0">
      <xsl:output omit-xml-declaration="yes"/>
      <xsl:template match="/">
        <xsl:for-each select="//*[local-name()='dmFile']">
          <xsl:value-of select="@dmFileDescr"/>
          <xsl:text>&#xa;</xsl:text>
        </xsl:for-each>
      </xsl:template>
    </xsl:stylesheet>`;
      const fileNames = transformXml(xmlContent, listStylesheet).trim().split('\n');

      const container = document.getElementById('downloadLinks');
      // Clear previous links
      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }
      document.getElementById('result').classList.remove('hidden');

      fileNames.forEach((file) => {
        const dumpStylesheet = `
      <xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" version="1.0">
        <xsl:output omit-xml-declaration="yes"/>
        <xsl:template match="/">
          <xsl:value-of select="//*[local-name()='dmFile' and @dmFileDescr='${file}']/*[local-name()='dmEncodedContent']/text()"/>
        </xsl:template>
      </xsl:stylesheet>`;

        const encodedContent = transformXml(xmlContent, dumpStylesheet);
        const decodedContent = atob(encodedContent);
        const byteArray = new Uint8Array(decodedContent.length);
        for (let i = 0; i < decodedContent.length; i++) {
          byteArray[i] = decodedContent.charCodeAt(i);
        }

        const blob = new Blob([byteArray], { type: "application/pdf" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = file;
        a.textContent = `üìÑ ${file}`;
        a.className = "block w-full py-2 px-4 bg-lime-100 rounded-md hover:bg-lime-200 transition duration-150 ease-in-out mt-4 flex gap-2 fade-in-pop";

        container.appendChild(a);
      });
    }

    const transformXml = (xmlContent, xsltString) => {
      const parser = new DOMParser();
      const xsltProcessor = new XSLTProcessor();

      const xslStylesheet = parser.parseFromString(xsltString, "application/xml");
      xsltProcessor.importStylesheet(xslStylesheet);

      const xmlDoc = parser.parseFromString(xmlContent, "application/xml");
      const fragment = xsltProcessor.transformToFragment(xmlDoc, document);

      const serializer = new XMLSerializer();
      return serializer.serializeToString(fragment);
    }
  </script>
</body>

</html>